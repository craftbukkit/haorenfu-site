#!/bin/sh
# Maven Wrapper script for Unix/Linux/macOS

set -e

# Find project base directory
find_maven_basedir() {
    if [ -z "$1" ]; then
        echo "Path not specified to find_maven_basedir"
        return 1
    fi
    basedir="$1"
    wdir="$1"
    while [ "$wdir" != '/' ]; do
        if [ -d "$wdir"/.mvn ]; then
            basedir=$wdir
            break
        fi
        wdir=$(dirname "$wdir")
    done
    printf '%s' "$basedir"
}

BASE_DIR=$(find_maven_basedir "$(dirname "$0")")
if [ -z "$BASE_DIR" ]; then
    exit 1
fi

MAVEN_PROJECTBASEDIR="${MAVEN_BASEDIR:-$BASE_DIR}"
export MAVEN_PROJECTBASEDIR

WRAPPER_PROPERTIES="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.properties"
WRAPPER_JAR="$MAVEN_PROJECTBASEDIR/.mvn/wrapper/maven-wrapper.jar"

# Download wrapper jar if not present
if [ ! -f "$WRAPPER_JAR" ]; then
    if [ -f "$WRAPPER_PROPERTIES" ]; then
        WRAPPER_URL=$(grep "wrapperUrl" "$WRAPPER_PROPERTIES" | cut -d'=' -f2-)
        if [ -n "$WRAPPER_URL" ]; then
            echo "Downloading Maven Wrapper..."
            if command -v curl > /dev/null 2>&1; then
                curl -sSL -o "$WRAPPER_JAR" "$WRAPPER_URL"
            elif command -v wget > /dev/null 2>&1; then
                wget -q -O "$WRAPPER_JAR" "$WRAPPER_URL"
            else
                echo "Error: Neither curl nor wget found. Cannot download maven-wrapper.jar"
                exit 1
            fi
        fi
    fi
fi

# If wrapper jar exists, use it
if [ -f "$WRAPPER_JAR" ]; then
    exec java -jar "$WRAPPER_JAR" "$@"
fi

# Fallback: Download and extract Maven directly
MAVEN_HOME="${MAVEN_HOME:-$HOME/.m2/wrapper/dists/apache-maven-3.9.6}"
MAVEN_BIN="$MAVEN_HOME/bin/mvn"

if [ ! -f "$MAVEN_BIN" ]; then
    echo "Downloading Apache Maven 3.9.6..."
    mkdir -p "$HOME/.m2/wrapper/dists"
    MAVEN_URL="https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.6/apache-maven-3.9.6-bin.tar.gz"
    
    TEMP_FILE=$(mktemp)
    if command -v curl > /dev/null 2>&1; then
        curl -sSL -o "$TEMP_FILE" "$MAVEN_URL"
    elif command -v wget > /dev/null 2>&1; then
        wget -q -O "$TEMP_FILE" "$MAVEN_URL"
    else
        echo "Error: Neither curl nor wget found"
        exit 1
    fi
    
    tar -xzf "$TEMP_FILE" -C "$HOME/.m2/wrapper/dists"
    rm "$TEMP_FILE"
fi

exec "$MAVEN_BIN" "$@"
